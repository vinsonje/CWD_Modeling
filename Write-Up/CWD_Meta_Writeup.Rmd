---
title: "Modeling Chronic Wasting Disease - Metapopulation Model"
author: "John Vinson"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r "load packages", echo = FALSE, warning = FALSE}
library(knitr)
library(kableExtra)
library(ggplot2)
library(cowplot)
```

```{r "set wd and seed", echo = FALSE, warning = FALSE}
set.seed(101)
setwd("C:/Users/SIU856560341/Desktop/CWD_Modeling/Write-Up")
```

## Model Overview

We developed a metapopulation model that describes the transmission of chronic wasting disease (CWD) on a landscape. The model tracks families (groups) of individuals, including the number of susceptible (S), exposed (E), and infectious (I) individuals in each family. We assume that families can relocate on the landscape but individuals can move (implicitly, i.e. we do not directly track their movements) to have both direct and indirect contacts (prions) with individuals in other families and locations on the landscape. Susceptible individuals can become infected via direct contacts with infectious individuals after which they transition to exposed. Exposed individuals become infectious, whereby they begin shedding prions into the environment (their current location/cell). Infectious individuals that die, not via hunting or sharpshooting), can quickly release a large number of prions through their corpse. These prions persist in the environment and susceptible individuals that come into contact with them can become infected (transition to exposed). 

Births result in new susceptible individuals, and all individuals can die through natural mortality. All individuals can be harvested (die) via hunting. Harvested individuals can be sent for testing to determine infection status. Positive identifications are used to determine where sharp shooting (culling events) occur on the landscape. 

```{r compartment image, echo = FALSE, fig.align = "center", fig.cap = "Fig 1. Simple diagram of CWD transmission in model"}
include_graphics("C:/Users/SIU856560341/Desktop/CWD_Modeling/Write-Up/Images/CWD Compartment Diagram.jpg")
```

## Process

We can break down our simulation algorithm into distinct processes involving initialization of the simulation, simulating a single run, and generating outputs/summaries.

### Initialize

#### Create the landscape (grid)

A **grid.xmax** x **grid.ymax** units^2^ (**area**) grid that represents the landscape is generated. The landscape is separated into cells each of **cell.x.size** by **cell.y.size** units^2^. 

This creates a matrix with the cell/grid id, the x and y coordinates of the bottom left corner, the coordinates of the top right corner, and the midpoints (centroids) of each cell. 

#### Initialize the familes (population) on the landscape

Given the total number of individuals (**N0**, $density * area$), families are placed onto the landscape. Initially families do not overlap (occupy the same cell). 

Roughly $\frac{N0}{fs}$ families are placed onto the landscape with locations determined from a binomial distribution (probability of success set as the probability of occupancy; number of families/number of cells), with an average family size of **fs** individuals. Family sizes are drawn from a Poisson distribution with mean **fs**. All the individuals are assumed to be susceptible. 

#### Initialize infection

To start infection on the landscape, a single infectious individual is placed in the center of the landscape.

This is done by creating a family with a single individual that is infectious at the midpoint of the landscape.


```{r landscape example, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "center", fig.cap = "Fig. 2. Example landscape and family occupancy. 100 x 100 km^2 with a cell size of 1 x 1 km^2. Density is 5 individuals/km with an average family size of 12 individuals. Colored points present familes with the intensity representing the number of individuals. The pink triangle is the single infectious individual."}

setwd("C:/Users/SIU856560341/Desktop/CWD_Modeling/Metapop_Model/Scripts")
source(paste(getwd(), "/CWDSourcer.R", sep = ''))

pop = init.CWD()[[1]]

ggplot() + geom_point(aes(x = pop[,5], y = pop[,6], color = pop[,1])) + 
  # geom_text(aes(x = grid[,6], y = grid[,7], label=grid[,1]), alpha=0.75, color="#997009", size = 3.0) +
  geom_point(aes(x = tail(pop[,5], 1), y = tail(pop[,6], 1)), shape = 17, size = 3, color = "#FF69B4") +
  theme_cowplot() + ylab("Y (km)") + xlab("X (km)") + 
  scale_color_gradient(name = "family size", low = "#009b00", high = "#002000")
```

### Run simulation

Once everything is initialized, the simulation will repeat until the **thyme**, the maximum number of time steps, is reached. 

#### Relocate families (movement)

Families can relocate to a new cell. For each family on the landscape, the distance that they "relocate" is sampled from a gamma distribution (shape and scale from **shift**). If the distance they relocate is less than their home range size, **inc**, then the family does not move. If it is greater and they do relocate, they are able to move to cell within the range of the sampled distance (excluding the cell they care currently in). There are three movements strategies in deciding where to move, **move.strat**: "random" (individuals move to a random cell withing their range), "avoid" (families move to cells that are least occupied/have the lowest density), and "**max.den**" (there is a maximum threshold density and families cannot move to cells that meet or have exceeded that density).

#### Dispersal (Interfamily Immigration)

Individuals can relocate (disperse) between families whereby they leave their original family and join a new one. We assume that individuals can disperse at specific times during the simulation, **disp.times**, during which they disperse at rate **dispersal.rate**. Each time step, an individual has a probability of dispersing:

$$
p(dispersal.rate) = 1 - e^{-dispersal.rate}
$$

When an individual disperses, the distance they can disperse is drawn from a gamma distribution with shape and scale parameters, **disp.dist**. If there are no families within range, they do not relocate and stay within their current location and family. The location and family that the individual relocates to is randomly drawn from all possible family locations, excluding the current family that it is in. 

#### State changes

This is a large process that encapsulates many different demographic and epidemiological processes. 

##### Births

We assumed an underlying logistic growth model, meaning that in the absence of disease, the population ($N$) dynamics should be described by: 

$$
\frac{dN}{dt} = b N (1 - \frac{N}{K}) - dN
$$
Here, **K** is the maximum number of individuals that can be supported on the landscape (carrying capacity), b is the birth rate, and d is the death rate. 

We assume that births can only occur at specific timepoints, **birth.times**. If continuous births are needed, then the **birth.times** should be assigned for each time point. To simulate birth events, we calculate the density-dependent births (DDB; $b N (1 - \frac{N}{K})$) using **Pbd** as the birth rate, $b$. Because there could be instances where the population is above K, we set the DDB to have a minimum of 0, meaning the DDBR is 0 when the population is at or above K. We then sample the number of new individuals (i.e. the number of births) from a Poisson distribution with a mean of DDB. Because these individuals need to be distributed across all families, we separate these new individuals into subgroups that sum to the total number of new individuals. To control the births (e.g. so that one cell does not result in the majority of births), we set a maximum number of new individuals per group to 10. We determine which cells are assigned these groups.   


##### Natural deaths

To simulate natural death events, we calculate the probability of natural mortality using the *lifespan* parameter, the average time an individual lives before it dies of natural causes: 

$$
p(lifespan) = 1 - e^{-\frac{1}{lifespan}}
$$

Using this probability ($p(d)$), we go through *each live* individual (all S, E, and I) in the population and determine if they die from natural causes (random sample from a Binomial distribution with success probability $p(d)$). Infectious individuals who die are moved to a compartment representing infectious corpses as they can release prions into the environment (corpse burst).

##### Transitions

##### Infection events (S -> E)

Individuals can become infected through two way, direct and environmental (via prions) transmission. 

###### Force of Infection

The force of infection ($\lambda$) is defined as the (per capita) rate that susceptible individuals become infected. The probability that an susceptible individual becomes infected is: 

$$
p(\lambda) = 1 - e^{-\lambda}
$$

Traditionally, the force of infection can be broken down into three components: the contact rate between individuals, the probability that the contact is with an infected individual, and the probability of successful transmission given a contact. Here, we will simplify this as we can calculate the probability of contact with an infected individual and provide the probability of transmission given contact. 

As there are two ways that individuals can become infected, we need to calculate them separately. Also, because location contributes to contact probabilities (and rates) each cell should have a unique force of infection. 

###### Direct Transmission

A susceptible individual can become infected through a contact with an infectious individual. To determine the probability of this occurring, we need to calculate the probability of contact given the distance between two cells. Using a glm fitted to direct contact data (right now I'm using fake data; **F2**), for every family with infectious (I) individuals, we determine the probability of contact the individuals in those cells with infected families have with all other cells in the landscape. We then multiply each probability of contact by the probability of successful direct transmission (**B1**).  We assumed that within-cell transmission may have a different probability of transmission (**F1**). These are then summed for each cell on the landscape, to get the cumulative force of infection exerted on each cell on the landscape from all cells with infectious individuals ($B_{D}$).

###### Environmental (prion) transmission

A susceptible individual can become infected through "contact" with prions on the environment (cells). To determine the probability of this occurring, we need to calculate the probability of contact with prions in a cell given the distance between two cells. Using a glm fitted to indirect contact data (right now using fake data; **F2i**) for every cell with prions on them, we determine the probability of contact that individuals in cells on the landscape have with the prions on those prion-infected cells. Since the probability of successful transmissions could be a function of the number of prions on a cell, we assume a logistic relationship between the number of prions in a cell ($P$), and the probability of successful transmission via prions ($p(P)$): 

$$
p(P) = \frac{1}{1 + e^{B1P.m P + B1P.inter}}
$$

Here, **B1P.m** controls how quickly the probability switches from ~0 to ~1.0 and **B1P.inter** controls where at what value of P the switch occurs. We multiply the indirect contact probability by the probability of successful prion transmission. These are summed for each cell on the landscape to get the cumulative force of infection exerted by prion infected cells on each cell the landscape ($B_{P}$). 


To get the total force of infection/transmission ($\lambda$), we need to sum the transmission from direct ($B_{D}$) and environmental (prions) ($B_{P}$), $\lambda = B_{D} +B_{P}$. Using the probability of infection ($p(\lambda)$) for each cell on the landscape, we got through each susceptible individual to determine if they become infected. 

##### Latent period (E -> I)

Individuals who become infected transition to the exposed (E) class, where they are infected but are not capable of transmitting the parasite or shed prions into the environment, yet. On average, individuals become infectious **latent.period** time units after becoming infected. The probability that an exposed individual becomes infectious, at each time step, is:

$$
p_{EI} = 1 - e^{-\frac{1}{latent.period}}
$$

At each time step, we go through each exposed individual and determine if they transition to infectious. 

##### Disease-induced mortality (I -> Dead,Z)

Along with dying due to natural causes, infectious individuals (I) can die through infection. On average, infectious individuals die due to infection after **inf.period** time units. The probability that an infectious individual dies due to infection is:

$$
p_{IZ} = 1 - e^{-\frac{1}{inf.period}}
$$

When these individuals die due to infection, they are moved to a compartment representing infectious corpses. These are kept track of as they lead to a burst of prions into the cell they die in (corpse burst).

#### Shedding

Infectious individuals shed prions into the currently occupied cell at an average rate **shed**. To determine how many each individual sheds into their cell, we loop through each infectious individual and draw the number they shed from a Poisson distribution with mean **shed**. 

#### Corpse burst

Corpses of infectious individuals who die from natural causes or infection release a large number of prions into the environment. For simplicity, we assume that these corpses only do a single release in the same time step that they died. On average a corpse releases **corpse.burst** prions in the cell they died in. To determine the number each one releases, we go through each corpse on the landscape and the number released is drawn from a Poisson distribution with mean **corpse.burst**. 

#### Removal of prions

Prions do not stay in the environment indefinitely. We roughly describe the dynamics of the prions as:

$$
\frac{dP}{dt} = sI + bZ - lP
$$

Here, $s$ represents the shedding rate of infectious individuals, $b$ is the "burst rate" of corpses that died from infection, and l is the loss rate of prions with $\frac{1}{l}$ is the average **lifespan_P** of prions in the environment. The probability that a prion is "lost" each time step is

$$
p_{Pl} = 1 - e^{-l} = 1 - e^{-\frac{1}{lifespan_P}} 
$$

#### Harvesting

Along with natural, and disease-induced, mortality, individuals on the landscape are at risk of removal via harvesting, or hunting. Prior to running a simulation, we assign the times (**h.times**) that harvesting can happen on the landscape and number of permits (**h.permits**). This means that in each run a total of $h.times * h.permits$ permits are given out. Additionally, the number of individuals that can be removed per permit (**h.num**) is assigned. During a harvesting event (time point), the locations where events occur are randomly drawn from all cells. At each location, harvesting can affect all the individuals within a radius (**h.radius**) around the cell. To determine which individuals are harvested within the radius, we randomly sample from all individuals in the area. We keep track of individuals who are harvested as these individuals are used in our surveillance method.

#### Surveillance

To determine where to sharpshoot, we use the individuals that are harvested to see if there are any infected individuals in that area. Prior to starting a simulation, we assign the time(s) that surveillance starts (**sur.start**). Using all the harvested individuals prior to this time point, **test.rate** of the harvested are tested for CWD. When tested, these tests are not perfect and we assign the true positive accuracy, the proportion of E (**true.pos.E**) and I (**true.pos.I**) that are correctly identified as infected, and the true negative accuracy, the proportion of S (**true.neg**) that are correctly identified as not infected. Using these identifications, we then determine where these infected (both correctly, "True Positive", and incorrectly, "False Positive", identified) are located. 

#### Sharpshooting

Sharpshooting, much like harvesting,  removes individuals from the landscape. However, because we have surveillance about where infected individuals are located, we decided where to sharpshoot based on the locations from the surveillance. Before running a simulation, we assign when sharp shooting events occur (**ss.time**). Like harvesting, sharpshooting affects all the individuals within a radius (**ss.radius**) around the location where it occurs. But rather than assigning a discrete number of individuals removed, a proportion of all individuals within the radius are removed (**ss.eff**). We also assign a strategy (**ss.strat**) for sharpshooting: **random** (randomly choose where to go shootshoot for surveillance), **priority** (go to locations that have the highest number of positive identifications).


### Tracking statistics/measures, Summarizing dynamics

Rather than always keeping track of the entire population as an output, which is very data heavy, we keep track of the quantities of interest that are important for understanding transmission dynamics and the spatial spread of the pathogen. Each time step, we record: 

- the total population size
- the number of S, E and I each time step
- the number of families that have S, E, and I in them
- location of infected individuals
- the area that has the infected individuals, maximum distance between two infected individuals, and the number of cells that have infected individuals
- total number of births
- the number of new infections, incidence
- the locations and SEI number of harvested individuals
- the locations and number of false positive and true negatives (surveillance)
- the locations and number removed from sharpshooting
- large dataframe of all population information (not always tracked)
- the landscape prions dataframe

## Example Dynamics

```{r example dynamics gif, echo = FALSE, fig.align = "center", fig.cap = "Fig 3. Example dynamics using parameters in Table 1."}
include_graphics("C:/Users/SIU856560341/Desktop/CWD_Modeling/Write-Up/Images/Meta_outbreak.gif")
```

## Parameters

```{r "parms table", echo = FALSE}
source(paste0(getwd(), "/parms_table.R"))
parm.df = data.frame(parmeter = all.parm.names, meaning = all.parm.mean, value = all.parm.vals)

kable(parm.df, "html", caption = "Table 1. Table of parameters, meaning and values to generate the example dynamics.") %>%   kable_styling(full_width = F) %>%
  column_spec(1, width = '1in') %>% column_spec(2, width = '4in') %>% column_spec(3, width = '4in')
```